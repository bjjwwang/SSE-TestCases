/*
CVE-ID: CVE-2022-29023
Description: A buffer overflow in the razermouse driver of OpenRazer v3.3.0 and below allows attackers to cause a Denial of Service (DoS) via a crafted buffer sent to the matrix_custom_frame device. 
*/

#include <stdio.h>
#include <string.h>
#include <ftw.h>
#include <stdlib.h>
#include <pthread.h>
#include <unistd.h>
#include <errno.h>
#include <limits.h>

#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

#include <sys/ioctl.h>

#include <assert.h>

struct razer_report {
    unsigned char arguments[80];
};

struct razer_report get_razer_report() {
    struct razer_report new_report = {0};
    memset(&new_report, 0, sizeof(struct razer_report));
    return new_report;
}

struct razer_report razer_chroma_standard_matrix_set_custom_frame(unsigned char start_col, unsigned char stop_col, unsigned char *rgb_data) {
    size_t row_length = (size_t) (((stop_col + 1) - start_col) * 3);
    struct razer_report report = get_razer_report(); 
    //assert(row_length <= sizeof(report.arguments) - 4);
    memcpy(&report.arguments[4], rgb_data, row_length); //potential buffer overflow
    return report;
}

ssize_t razer_attr_write_set_key_row(const char *buf, size_t count) {
    struct razer_report report = {0};
    size_t offset = 0;
    unsigned char row_id;
    unsigned char start_col;
    unsigned char stop_col;
    unsigned char row_length;

    while(offset < count) {
        if(offset + 3 > count) {
            break;
        }

        row_id = buf[offset++];
        start_col = buf[offset++];
        stop_col = buf[offset++];
        row_length = ((stop_col+1) - start_col) * 3;
        //printf("start_col: %zu\n", (size_t)start_col);
        //printf("stop_col: %zu\n", (size_t)stop_col);
        //printf("row_length: %zu\n", (size_t)row_length);

        if(start_col > stop_col || offset + row_length > count) {
            break;
        }
        if(offset + row_length > count) {
            break;
        }

        report = razer_chroma_standard_matrix_set_custom_frame(start_col, stop_col, (unsigned char*)&buf[offset]);
        offset += row_length;
    }
    return count;
}

int main() {
    razer_attr_write_set_key_row("13aa45", 144);
}
