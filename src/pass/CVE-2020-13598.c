/*
CVE-ID: CVE-2020-13598
Description: FS: Buffer Overflow when enabling Long File Names in FAT_FS and calling fs_stat. Zephyr versions >= v1.14.2, >= v2.3.0 contain Stack-based Buffer Overflow (CWE-121).
*/

#include <stdbool.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <assert.h>

#define _USE_LFN 1

#define MAX_FILE_NAME 12 /* Uses 8.3 SFN */
#define	_MAX_LFN	255

typedef struct {
#if _USE_LFN != 0
	char fname[_MAX_LFN + 1]; /* Primary file name */
#else
	char fname[13];
#endif
} FILINFO;

struct fs_dirent {
	char name[MAX_FILE_NAME + 1];
};

void fatfs_stat(struct fs_dirent *entry, FILINFO fno) {
    if (true) { //nd()
        //assert(strlen(fno.fname) < 13);
		strcpy(entry->name, fno.fname); //potential buffer overflow
	}
}

int main() {
    struct fs_dirent fsdir;
    FILINFO filinfo;
    strcpy(filinfo.fname, "01234567890123456789");
    fatfs_stat(&fsdir, filinfo);
}
