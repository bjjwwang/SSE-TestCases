/*
CVE-ID: CVE-2021-39602
A Buffer Overflow vulnerabilty exists in Miniftpd 1.0 in the do_mkd function in the ftpproto.c file, which could let a remote malicious user cause a Denial of Service. 
*/

#include <errno.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <sys/stat.h>
#include <unistd.h>
#include <assert.h>

#define MAX_BUFFER_SIZE 1024
#define MAX_ARG 1024

#define FTP_MKDIROK 257
#define FTP_FILEFAIL 550
#define FTP_NOPERM 550

typedef struct session {
	char arg[MAX_ARG];
}session_t;

static void do_mkd(session_t *sess) {
	if(mkdir(sess->arg, 0755) < 0) {
		if(errno == EEXIST) {
			printf("%s\n", "Create directory operation failed.");
		}
		else {
			printf("%s\n", "Permission denied.");
		}
		return;
	}
	char buf[MAX_BUFFER_SIZE] = {0};
	if(getcwd(buf, MAX_BUFFER_SIZE) != NULL) {
        //assert((strlen(buf) + strlen(sess->arg) + 11) < sizeof(buf));
		sprintf(buf, "\"%s\\%s\" created",buf,sess->arg); //potential buffer overflow if path length is too long
        //printf("%d\n", strlen(buf));
	}
}

int main() {
	session_t sess;
    strcpy(sess.arg, "dQTzRwmNuJFoD9pFIwx97jfTRv1rAbvZ0Wcz6FdQU6uBcM6TreKoHvS0418qcGBLSqRCK4o7K0VxcfZ8btrUiIGMYbvdFdXueAvE3DrvmwaoFb06t3ZkpNw9HrSB7xCsJmdo86ZhrrCMlIx0m7im6zwBM3qnjds3OW6seTegTihzANyeZQmH1ojYIb7nZJEBJkFu7Ov8IBifYUFjoZNVdaTEmD8CnXnthnDYB45ssxTkcsPMbF2oLycwepI0jmd");

    do_mkd(&sess);
}
