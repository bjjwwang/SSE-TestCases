/*
CVE-ID: CVE-2022-34835
Description: In Das U-Boot through 2022.07-rc5, an integer signedness error and resultant stack-based buffer overflow in the "i2c md" command enables the corruption of the return address pointer of the do_i2c_md function. 
*/

#include <stdlib.h>
#include <stdint.h>
#include <stdio.h>
#include <inttypes.h>

#include <assert.h>

#define DISP_LINE_LEN 16

int do_i2c_md(int argc, char *const argv[]) {
	uint32_t length = 0;
	int32_t nbytes;
	int32_t linebytes;

	if (argc < 3) {
		return -1;
	}

	if (argc > 3) {
		length = strtol(argv[3], NULL, 16);
	}

	nbytes = length;
	do {
		unsigned char	linebuf[DISP_LINE_LEN];
		linebytes = (nbytes > DISP_LINE_LEN) ? DISP_LINE_LEN : nbytes;
		printf("%d\n", linebytes);
		i2c_read_bytewise(linebuf, linebytes);
		nbytes -= linebytes;
	} while (nbytes > 0);

	return 0;
}

struct i2c_msg {
	uint8_t *buf;
};


int i2c_read_bytewise(uint8_t *buffer, uint32_t len) {
	struct i2c_msg msg[2], *ptr;
	int i;
	//printf("%" PRIu32 "\n", len);

	for (i = 0; i < len; i++) {
		ptr = msg + 1;
		//assert(i < DISP_LINE_LEN);
		ptr->buf = &buffer[i]; //potential buffer overflow
		ptr++;
	}

	return 0;
}

int main(int argc, char *argv[]) {
	do_i2c_md(argc, argv); //argv = 0 0 0x80000100
}

