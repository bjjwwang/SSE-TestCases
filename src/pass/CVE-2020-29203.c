/*
CVE-ID: CVE-2020-29203
Description: struct2json before 2020-11-18 is affected by a Buffer Overflow because strcpy is used for S2J_STRUCT_GET_string_ELEMENT. 
*/

#include <stdint.h> 
#include <stdio.h> 
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <assert.h>

typedef struct { 
  char name[8]; 
} Hometown; 

/* The cJSON structure: */
typedef struct cJSON {
	struct cJSON *child;		/* An array or object item will have a child pointer pointing to a chain of the items in the array/object. */
	char *valuestring;			/* The item's string, if type==cJSON_String */
	char *string;				/* The item's name string, if this item is the child of, or is in the list of subitems of an object. */
} cJSON;

#define S2J_CREATE_STRUCT_OBJECT(struct_obj, type) \
    cJSON *json_temp; \
    type *struct_obj = malloc(sizeof(type)); \
    if (struct_obj) memset(struct_obj, 0, sizeof(type));

#define S2J_STRUCT_GET_string_ELEMENT(to_struct, from_json, _element) \
    json_temp = from_json->child; \
    /*assert(sizeof(to_struct->_element) >= strlen(json_temp->valuestring) + 1);*/ \
    if (json_temp) strcpy((to_struct)->_element, json_temp->valuestring); //potential buffer overflow

static char* cJSON_strdup(const char* str) {
      size_t len = strlen(str) + 1;
      char *copy = (char*)malloc(len);
      memcpy(copy,str,len);
      return copy;
}

cJSON *cJSON_CreateString(const char *string) {
    cJSON *item = (cJSON*)malloc(sizeof(cJSON));
    item->valuestring=cJSON_strdup(string);
    return item;
}

void cJSON_AddItemToArray(cJSON *array, cJSON *item) {
    cJSON *c = array->child;
    if (!c) {
        array->child = item;
    }
}

void cJSON_AddItemToObject(cJSON *object,const char *string,cJSON *item) {
    item->string=cJSON_strdup(string);
    cJSON_AddItemToArray(object,item);
}
 
static void *json_to_struct(cJSON* json_obj) { 
  S2J_CREATE_STRUCT_OBJECT(struct_hometown, Hometown); 
  S2J_STRUCT_GET_string_ELEMENT(struct_hometown, json_obj, name); 
  return struct_hometown; 
} 
 
int main() { 
  cJSON *json = (cJSON*)malloc(sizeof(cJSON)); 
  cJSON_AddItemToObject(json, "name", cJSON_CreateString("ABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZ")); 
  Hometown * test = json_to_struct(json); 
  //printf("%s\n", test->name);
}
