/*
CVE-ID: CVE-2021-44975
Description: radareorg radare2 5.5.2 is vulnerable to Buffer Overflow via /libr/core/anal_objc.c mach-o parser.
*/

#include <stdlib.h>
#include <stdbool.h>
#include <string.h>
#include <stdio.h>
#include <assert.h>

#define ut64 unsigned long long
#define ut8 unsigned char
#define R_MAX(x,y) (((x)>(y))?(x):(y))
#define R_MIN(x,y) (((x)>(y))?(y):(x))

typedef struct r_io_t {
	ut8 Oxff; // which printable char to use instead of 0xff for unallocated bytes
} RIO;

typedef struct r_bin_section_t {
	ut64 vsize;
} RBinSection;

struct r_core_t {
	RIO *io;
};
typedef struct r_core_t RCore;

typedef struct {
	RCore *core;
	size_t file_size;
	RBinSection *_selrefs;
	RBinSection *_const;
} RCoreObjc;

int r_io_pread_at(RIO* io, ut8* buf, int len) {
	if(!(io && buf && len >= 0)) {
		return -1;
	}
	if (true) { //nd()
		//assert(len <= maxsize);
		memset(buf, io->Oxff, len); //potential buffer overflow
		printf("%s\n", buf);
	}
	return 1;
}

bool internal_r_io_read_at(RIO *io, ut8 *buf, int len) {
	if (len < 1) {
		return false;
	}
	bool ret = r_io_pread_at (io, buf, len) > 0;
	return ret;
}


bool r_io_read_at(RIO *io, ut8 *buf, int len) {
	if(!(io && buf && len >= 0)) {
		return false;
	}
	if (len == 0) {
		return false;
	}
	return internal_r_io_read_at (io, buf, len);
}

bool objc_build_refs(RCoreObjc *objc) {
	size_t ss_const = objc->_const->vsize;
	size_t ss_selrefs = objc->_selrefs->vsize;

	// TODO: check if ss_const or ss_selrefs are too big before going further
	size_t maxsize = R_MAX (ss_const, ss_selrefs);
	maxsize = R_MIN (maxsize, objc->file_size);

	ut8 *buf = calloc (1, maxsize);
	if (!buf) {
		return false;
	}
	if (!r_io_read_at (objc->core->io, buf, ss_const)) { //uses unsanitized value ss_const
		printf ("aao: Cannot read the whole const section %zu\n", ss_const);
		return false;
	}
	return true;
}

int main() {
	RIO io;
	io.Oxff = 'a';

	RCore core;
	core.io = &io;

	RBinSection selrefs;
	RBinSection rconst;
	selrefs.vsize = 3;
	rconst.vsize = 10;	

	RCoreObjc objc;
	objc.core = &core;
	objc.file_size = 5;
	objc._selrefs = &selrefs;
	objc._const = &rconst;

	objc_build_refs(&objc);
}
