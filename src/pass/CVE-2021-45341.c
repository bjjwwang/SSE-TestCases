/*
CVE-ID: CVE-2021-45341
Description: A buffer overflow vulnerability in CDataMoji of the jwwlib component of LibreCAD 2.2.0-rc3 and older allows an attacker to achieve Remote Code Execution using a crafted JWW document.
*/

#include <string.h>
#include <stdlib.h>
#include <stdio.h>
#include <stdbool.h>
#include <assert.h>

//NOTE: original function reads from ifstream (C++) to buf without checking the streamsize. In this demonstration, we use a char pointer to represent the stream instead
void Serialize(char* ifstr) {
    int wd;
    char buf[512];

    char* ifstr_cpy = malloc(strlen(ifstr) + 1);
    strcpy(ifstr_cpy, ifstr);
    char* token = strtok(ifstr_cpy, " ");

    if(true) { //nd()
        token = strtok(NULL, " ");
        wd = atoi(token);
        
        token = strtok(NULL, "");
        //assert(wd < sizeof(buf));
        memcpy(buf, token, wd);
        buf[wd] = '\0';
        //printf("%s\n", buf);
    }
}

int main() {
    char* ifstr = "255 513 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789 0123456789";
    Serialize(ifstr);
}
