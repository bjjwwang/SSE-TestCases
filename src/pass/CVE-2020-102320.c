/*
CVE-ID: CVE-2020-10232
Description: In version 4.8.0 and earlier of The Sleuth Kit (TSK), there is a stack buffer overflow vulnerability in the YAFFS file timestamp parsing logic in yaffsfs_istat() in fs/yaffs.c.
*/

#include <stdint.h>
#include <stdlib.h>
#include <time.h>
#include <stdio.h>
#include <string.h>
#include <assert.h>
#include <stdbool.h>

#define LONG_TIMEZONE_NAME 1

char *tzname[2];
#define TZNAME	tzname

typedef struct {
    time_t mtime;           ///< last file content modification time (stored in number of seconds since Jan 1, 1970 UTC)
    time_t atime;           ///< last file content accessed time (stored in number of seconds since Jan 1, 1970 UTC)
    time_t ctime;           ///< last file / metadata status change time (stored in number of seconds since Jan 1, 1970 UTC)
} TSK_FS_META;

char * tsk_fs_time_to_str(time_t time, char buf[128]) {
    buf[0] = '\0';
    if (time <= 0) {
        strncpy(buf, "0000-00-00 00:00:00 (UTC)", 128);
    }
    else {
        struct tm *tmTime = localtime(&time);
        
        snprintf(buf, 128, "%.4d-%.2d-%.2d %.2d:%.2d:%.2d (%s)", //potential buffer overflow if long timezone name is used (buf is 32 bytes)
            (int) tmTime->tm_year + 1900,
            (int) tmTime->tm_mon + 1, 
            (int) tmTime->tm_mday, 
            tmTime->tm_hour,
            (int) tmTime->tm_min, 
            (int) tmTime->tm_sec,
            TZNAME[(tmTime->tm_isdst == 0) ? 0 : 1]);
    }
    printf("%s\n", buf);
    return buf;
}

void yaffsfs_istat(TSK_FS_META *fs_meta) {
    char timeBuf[32];

    if (true) { //nd()
        printf("\nAdjusted Inode Times:\n");
        printf("Accessed:\t%s\n", tsk_fs_time_to_str(fs_meta->atime, timeBuf));
        printf("File Modified:\t%s\n", tsk_fs_time_to_str(fs_meta->mtime, timeBuf));
        printf("Inode Modified:\t%s\n", tsk_fs_time_to_str(fs_meta->ctime, timeBuf));
    }
}

int main() {
    if(LONG_TIMEZONE_NAME) {
        tzname[0] = "Eastern Standard Time";
        tzname[1] = "Eastern Daylight Time";
    }
    else {
        tzname[0] = "EST";
        tzname[1] = "EDT";
    }

    TSK_FS_META fs_meta;
    fs_meta.mtime = 1641038400;
    fs_meta.atime = 1641038400;
    fs_meta.ctime = 1641038400;
    yaffsfs_istat(&fs_meta);
}
